---
const departments = [
  {
    name: "AtenciÃ³n al Cliente",
    phone: "51999928258",
    icon: "ðŸ’¬",
    schedules: [
      "Lun - Vie: 8:00 a.m â€“ 3:00 p.m  /  4:00 â€“ 6:00 p.m",
      "SÃ¡bados: 8:00 a.m â€“ 1:00 p.m"
    ]
  },
  {
    name: "DirecciÃ³n General",
    phone: "51999135300",
    icon: "ðŸ‘”",
    schedules: [
      "Lun - Vie: 8:00 a.m â€“ 3:00 p.m",
      "SÃ¡bados: 8:00 a.m â€“ 1:00 p.m"
    ]
  },
  {
    name: "CoordinaciÃ³n AcadÃ©mica Prim. â€“ Sec.",
    phone: "51986124565",
    icon: "ðŸ“š",
    schedules: [
      "Lun - Vie: 8:00 a.m â€“ 3:00 p.m",
      "SÃ¡bados: 8:00 a.m â€“ 1:00 p.m"
    ]
  }
];
---

<!-- BotÃ³n flotante de WhatsApp -->
<div class="whatsapp-container">
  <!-- Panel de horarios de atenciÃ³n -->
  <div class="whatsapp-menu">
    <div class="menu-header">
      <strong>Horarios de AtenciÃ³n</strong>
    </div>
    <div class="menu-options">
      {departments.map((dept, i) => (
        <>
          {i > 0 && <div class="menu-divider"></div>}
          <a 
            href={`https://wa.me/${dept.phone}?text=${encodeURIComponent("Â¡Hola! Me gustarÃ­a obtener mÃ¡s informaciÃ³n.")}`}
            target="_blank"
            rel="noopener noreferrer"
            class="menu-option"
          >
            <span class="option-emoji">{dept.icon}</span>
            <div class="option-content">
              <span class="option-name">{dept.name}</span>
              {dept.schedules.map(s => (
                <span class="option-schedule">{s}</span>
              ))}
            </div>
            <svg class="option-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </a>
        </>
      ))}
    </div>
  </div>

  <!-- BotÃ³n de WhatsApp -->
  <button 
    class="whatsapp-button"
    aria-label="Contactar por WhatsApp"
    id="whatsapp-toggle"
  >
    <svg class="whatsapp-icon" viewBox="0 0 32 32" fill="currentColor">
      <path d="M16.003 0C7.17 0 0.008 7.162 0.008 15.997c0 2.84 0.748 5.508 2.052 7.82L0.142 31.95l8.375-2.185c2.19 1.166 4.692 1.831 7.486 1.831 8.833 0 15.995-7.162 15.995-15.997S24.836 0 16.003 0zm9.366 22.595c-0.393 1.104-2.312 2.148-3.213 2.245-0.825 0.088-1.893 0.127-3.052-0.193-0.703-0.193-1.604-0.452-2.755-0.883-4.836-1.822-8.004-6.674-8.246-6.98-0.232-0.306-1.922-2.579-1.922-4.92 0-2.342 1.209-3.486 1.648-3.962 0.438-0.476 0.955-0.595 1.274-0.595 0.319 0 0.638 0.003 0.916 0.014 0.294 0.012 0.69-0.112 1.079 0.827 0.398 0.962 1.362 3.303 1.482 3.543 0.12 0.24 0.2 0.52 0.04 0.825-0.16 0.306-0.24 0.496-0.478 0.767-0.239 0.271-0.502 0.606-0.717 0.814-0.239 0.231-0.487 0.481-0.209 0.943 0.278 0.462 1.235 2.036 2.649 3.298 1.82 1.623 3.354 2.126 3.832 2.366 0.478 0.24 0.757 0.2 1.035-0.12 0.278-0.32 1.195-1.395 1.514-1.871 0.319-0.476 0.638-0.397 1.076-0.24 0.438 0.157 2.779 1.311 3.257 1.551 0.478 0.24 0.797 0.36 0.916 0.56 0.12 0.2 0.12 1.151-0.273 2.255z"/>
    </svg>
    <svg class="close-icon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
    </svg>
  </button>

  <!-- Pulso animado -->
  <div class="whatsapp-pulse"></div>
</div>

<script>
  function initWhatsApp() {
    const toggleBtn = document.getElementById('whatsapp-toggle');
    const menu = document.querySelector('.whatsapp-menu');
    const container = document.querySelector('.whatsapp-container');

    if (!toggleBtn || !menu || !container) return;

    // Evitar registrar listeners duplicados
    if ((toggleBtn as HTMLElement & { _wsp?: boolean })._wsp) return;
    (toggleBtn as HTMLElement & { _wsp?: boolean })._wsp = true;

    toggleBtn.addEventListener('click', () => {
      menu.classList.toggle('active');
      toggleBtn.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!container.contains(e.target as Node)) {
        menu.classList.remove('active');
        toggleBtn.classList.remove('active');
      }
    });
  }

  // Carga inicial (sin View Transitions)
  initWhatsApp();
  // DespuÃ©s de cada navegaciÃ³n con View Transitions
  document.addEventListener('astro:page-load', initWhatsApp);
</script>

<style>
  .whatsapp-container {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 12px;
  }

  .whatsapp-menu {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    width: 320px;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .whatsapp-menu.active {
    max-height: 600px;
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: all;
  }

  .menu-header {
    padding: 16px;
    background: #075e54;
    color: white;
    font-size: 15px;
    border-radius: 12px 12px 0 0;
  }

  .menu-options {
    display: flex;
    flex-direction: column;
  }

  .menu-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    text-decoration: none;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
  }

  .option-emoji {
    font-size: 24px;
    flex-shrink: 0;
  }

  .menu-option:last-child {
    border-bottom: none;
    border-radius: 0 0 12px 12px;
  }

  .menu-option:hover {
    background: #f5f5f5;
  }

  .option-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
  }

  .option-name {
    font-size: 13px;
    font-weight: 600;
    color: #075e54;
  }

  .option-schedule {
    font-size: 11px;
    color: #666;
  }

  .menu-divider {
    height: 1px;
    background: #e0e0e0;
    margin: 0 16px;
  }

  .option-icon {
    width: 20px;
    height: 20px;
    color: #999;
  }

  .whatsapp-button {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: #25D366;
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 16px rgba(37, 211, 102, 0.4);
    cursor: pointer;
    transition: all 0.3s ease;
    animation: slideInButton 0.5s ease-out;
    z-index: 2;
    flex-shrink: 0;
  }

  .whatsapp-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
  }

  .whatsapp-button:active {
    transform: scale(1.05);
  }

  .whatsapp-icon {
    width: 32px;
    height: 32px;
    transition: opacity 0.3s, transform 0.3s;
  }

  .close-icon {
    position: absolute;
    width: 28px;
    height: 28px;
    opacity: 0;
    transform: rotate(-90deg);
    transition: opacity 0.3s, transform 0.3s;
  }

  .whatsapp-button.active .whatsapp-icon {
    opacity: 0;
    transform: rotate(90deg);
  }

  .whatsapp-button.active .close-icon {
    opacity: 1;
    transform: rotate(0deg);
  }

  .whatsapp-pulse {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 60px;
    height: 60px;
    background: rgba(37, 211, 102, 0.5);
    border-radius: 50%;
    animation: pulse 1.8s infinite;
    z-index: 1;
  }

  @media (max-width: 480px) {
    .whatsapp-menu {
      width: calc(100vw - 40px);
      max-width: 320px;
    }

    .whatsapp-container {
      bottom: 20px;
      right: 20px;
    }

    .whatsapp-button {
      width: 56px;
      height: 56px;
    }

    .whatsapp-icon {
      width: 28px;
      height: 28px;
    }

    .close-icon {
      width: 24px;
      height: 24px;
    }

    .whatsapp-pulse {
      width: 56px;
      height: 56px;
    }
  }

  /* Animaciones */
  @keyframes slideInButton {
    from {
      opacity: 0;
      transform: scale(0.3);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }



  @keyframes pulse {
    0% {
      opacity: 0.8;
      transform: scale(1);
    }
    50% {
      opacity: 0;
      transform: scale(1.4);
    }
    100% {
      opacity: 0;
      transform: scale(1.4);
    }
  }

  /* Evitar que el botÃ³n tape contenido importante */
  @media print {
    .whatsapp-container {
      display: none;
    }
  }
</style>
